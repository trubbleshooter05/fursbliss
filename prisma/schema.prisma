// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum EmailSequenceEnrollmentStatus {
  active
  paused
  completed
  unsubscribed
}

enum EmailSequenceStepStatus {
  pending
  sent
  failed
  skipped
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  name               String?
  image              String?
  password           String
  emailVerified      DateTime?
  subscriptionStatus String   @default("free") // "free" or "premium"
  subscriptionId     String?  @unique
  subscriptionPlan   String?
  subscriptionEndsAt DateTime?
  stripeCustomerId   String?
  role               String   @default("user") // "user" or "admin"
  referralCode       String?  @unique
  referredById       String?
  referredBy         User?    @relation("UserReferrals", fields: [referredById], references: [id])
  referredUsers      User[]   @relation("UserReferrals")
  emailPreferences   Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @default(now()) @updatedAt
  pets               Pet[]
  notifications      Notification[]
  referrals          Referral[]
  quizSubmissions    QuizSubmission[]
  emailSequenceEnrollments EmailSequenceEnrollment[]
}

model Pet {
  id                String      @id @default(cuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  name              String
  species           String      @default("dog")
  breed             String
  age               Int
  dateOfBirth       DateTime?
  weight            Float
  sex               String?
  symptoms          Json        // array of symptoms
  photoUrl          String?
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @default(now()) @updatedAt
  healthLogs        HealthLog[]
  recommendations   Recommendation[]
  weightLogs        WeightLog[]
  medications       Medication[]
  doseSchedules     DoseSchedule[]
  photoLogs         PhotoLog[]
  supplements       PetSupplement[]
  gutHealthLogs     GutHealthLog[]
  aiInsights        AIInsight[]
  longevityDrugProfile LongevityDrugProfile?
  vetShareLinks     VetShareLink[]
}

model HealthLog {
  id             String   @id @default(cuid())
  petId          String
  pet            Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  date           DateTime @default(now())
  energyLevel    Int      // 1-10 scale
  appetite       String?
  mood           String?
  mobilityLevel  Int?
  moodLevel      Int?
  appetiteLevel  Int?
  symptoms       String?
  notes          String?
  weight         Float?
  photoUrl       String?
  improvements   Boolean  @default(false)
  createdAt      DateTime @default(now())
}

model Recommendation {
  id        String   @id @default(cuid())
  petId     String
  pet       Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  prompt    String
  response  String
  notes     String?
  createdAt DateTime @default(now())
}

model WeightLog {
  id        String   @id @default(cuid())
  petId     String
  pet       Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  date      DateTime @default(now())
  weight    Float
  createdAt DateTime @default(now())
}

model Medication {
  id        String   @id @default(cuid())
  petId     String
  pet       Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  name      String
  prescribedBy String?
  dosage    String
  frequency String
  startDate DateTime?
  endDate   DateTime?
  reason    String?
  notes     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
}

model DoseSchedule {
  id            String   @id @default(cuid())
  petId         String
  pet           Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  supplementId  String?
  supplement    PetSupplement? @relation(fields: [supplementId], references: [id], onDelete: Cascade)
  supplementName String
  dosage        String
  frequency     String
  times         Json
  scheduledTime String?
  daysOfWeek    String?
  notes         String?
  active        Boolean  @default(true)
  lastCompletedAt DateTime?
  createdAt     DateTime @default(now())
  doseCompletions DoseCompletion[]
}

model PhotoLog {
  id         String   @id @default(cuid())
  petId      String
  pet        Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  healthLogId String?
  imageUrl   String
  category   String?
  caption    String?
  aiAnalysis String?
  createdAt  DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String?
  title     String
  body      String
  read      Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())
}

model VerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Referral {
  id            String   @id @default(cuid())
  code          String
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitedEmail  String?
  redeemedById  String?
  redeemedAt    DateTime?
  createdAt     DateTime @default(now())
}

model PetSupplement {
  id        String   @id @default(cuid())
  petId     String
  pet       Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  name      String
  brand     String?
  dosage    String
  frequency String
  startDate DateTime?
  endDate   DateTime?
  isActive  Boolean  @default(true)
  category  String
  notes     String?
  createdAt DateTime @default(now())
  doseSchedules DoseSchedule[]
}

model DoseCompletion {
  id          String   @id @default(cuid())
  scheduleId  String
  schedule    DoseSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  completedAt DateTime @default(now())
  skipped     Boolean  @default(false)
  notes       String?
}

model GutHealthLog {
  id             String   @id @default(cuid())
  petId          String
  pet            Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  date           DateTime @default(now())
  stoolQuality   Int
  stoolNotes     String?
  gasLevel       Int?
  vomiting       Boolean  @default(false)
  appetiteChange String?
  createdAt      DateTime @default(now())
}

model AIInsight {
  id        String   @id @default(cuid())
  petId     String
  pet       Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  type      String
  content   String
  prompt    String
  model     String   @default("gpt-4")
  cached    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model LongevityDrugProfile {
  id                  String   @id @default(cuid())
  petId               String   @unique
  pet                 Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  loy002Eligible      Boolean  @default(false)
  loy002Interest      Boolean  @default(false)
  loy002Notes         String?
  onRapamycin         Boolean  @default(false)
  rapamycinDosage     String?
  rapamycinStartDate  DateTime?
  rapamycinPrescriber String?
  rapamycinFrequency  String?
  currentDrugs        String?
  bloodworkUploaded   Boolean  @default(false)
  lastBloodworkDate   DateTime?
  doseLogs            RapamycinDoseLog[]
}

model RapamycinDoseLog {
  id            String   @id @default(cuid())
  drugProfileId String
  drugProfile   LongevityDrugProfile @relation(fields: [drugProfileId], references: [id], onDelete: Cascade)
  date          DateTime @default(now())
  given         Boolean  @default(true)
  sideEffects   String?
  notes         String?
}

model BreedProfile {
  id                 String   @id @default(cuid())
  breed              String   @unique
  species            String   @default("dog")
  averageLifespan    Float
  seniorAgeStart     Int
  commonHealthIssues String
  riskTimeline       String
  supplementRecs     String
  longevityTips      String
  sizeCategory       String
  averageWeight      String
  seoSlug            String   @unique
  seoTitle           String
  seoDescription     String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @default(now()) @updatedAt
}

model FDADrugStatus {
  id                String   @id @default(cuid())
  drugName          String   @unique
  company           String
  currentStatus     String
  statusDetail      String
  lastUpdated       DateTime
  targetSpecies     String
  estimatedApproval String?
  sourceUrl         String?
  milestones        String
  updatedAt         DateTime @default(now()) @updatedAt
}

model BreedAggregate {
  id               String   @id @default(cuid())
  breed            String   @unique
  totalPets        Int      @default(0)
  avgAge           Float?
  topSupplements   String?
  topSymptoms      String?
  avgEnergyLevel   Float?
  avgMobilityLevel Float?
  lastCalculated   DateTime @default(now())
}

model VetShareLink {
  id         String   @id @default(cuid())
  petId      String
  pet        Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  token      String   @unique @default(cuid())
  expiresAt  DateTime
  viewCount  Int      @default(0)
  vetComment String?
  createdAt  DateTime @default(now())
}

model WaitlistSignup {
  id        String   @id @default(cuid())
  email     String   @unique
  source    String   @default("loy002")
  createdAt DateTime @default(now())
}

model QuizSubmission {
  id                String   @id @default(cuid())
  email             String
  dogName           String
  breed             String
  age               Int
  weight            Float
  concerns          String[]
  score             Int
  userId            String?
  emailSequenceStep Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
}

model QuizStepEvent {
  id         String   @id @default(cuid())
  sessionId  String   @map("session_id")
  stepNumber Int      @map("step_number")
  stepName   String   @map("step_name")
  timestamp  DateTime @default(now())

  @@index([sessionId, timestamp])
  @@index([stepNumber, timestamp])
  @@map("quiz_step_events")
}

model EmailSequenceEnrollment {
  id           String                        @id @default(cuid())
  userId       String
  user         User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sequenceType String                        @default("welcome_v1")
  status       EmailSequenceEnrollmentStatus @default(active)
  startedAt    DateTime                      @default(now())
  completedAt  DateTime?
  nextSendAt   DateTime?
  createdAt    DateTime                      @default(now())
  updatedAt    DateTime                      @updatedAt
  steps        EmailSequenceStep[]

  @@index([userId, sequenceType, status])
}

model EmailSequenceStep {
  id              String                  @id @default(cuid())
  enrollmentId    String
  enrollment      EmailSequenceEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  step            Int
  scheduledAt     DateTime
  sentAt          DateTime?
  status          EmailSequenceStepStatus @default(pending)
  resendMessageId String?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@index([status, scheduledAt])
  @@index([enrollmentId, step])
  @@index([resendMessageId])
}

model EmailEvent {
  id         String   @id @default(cuid())
  messageId  String
  eventType  String
  eventAt    DateTime @default(now())
  payloadJson Json
  createdAt  DateTime @default(now())

  @@index([messageId])
  @@index([eventType, eventAt])
}
